---
title: "環境構築"
free: true
---

## このページの目標
実際に開催されたISUCON11予選とほぼ同じ環境を構築します。
この本ではこのページで作った環境を前提に計測や改善を行いますが、他の環境でもほぼ同じ改善を行えると思います。
（他の環境の作成方法は[ISUCONの過去問にチャレンジするためのシンプルな環境構築 : ISUCON公式Blog](https://isucon.net/archives/54946542.html)などを参考にしてください）

## 前提
- AWSでアカウントを作成しコンソールにログインした状態から始めます
- 自分のGitHubアカウントに有効な公開鍵を登録しておいてください


## スタックの作成
AWSのコンソール上部の検索窓に「CloudFormation」と入力しCloudFormationのページに移動します。
![](/images/3.4/2021-09-01-20-43-25.png)

スタックの作成ボタンを押し、作成ウィザードを開始します。
![](/images/3.4/2021-09-01-20-45-34.png)

下のGistのyamlを保存します。
https://gist.github.com/tohutohu/7862dd3ebe96519b361d9985f42d2708

テンプレートの指定でテンプレートファイルのアップロードを選択し、先ほどダウンロードしたファイルを選択しアップロードします。
アップロードができたら「次へ」のボタンを押します。
![](/images/3.4/2021-09-01-20-55-05.png)

スタックの名前と自分のGitHub IDを入力します。
スタックの名前は任意の名前を指定して構いません。ここでは例としてisucon-practiceを入力しています。
入力ができたら「次へ」のボタンを押します。
![](/images/3.4/2021-09-01-20-55-53.png)

スタックオプションの設定というページが出ますが、ここでは何も変更せず「次へ」のボタンを押します。
![](/images/3.4/2021-09-01-20-57-21.png)

レビューのページが表示されます。
最下部の確認事項にチェックを入れて「スタックの作成」ボタンを押します。
![](/images/3.4/2021-09-01-20-58-38.png)

以下のような画面になればスタックの作成が開始されています。
![](/images/3.4/2021-09-01-21-00-27.png)

スタックの作成には5分くらいかかります。

何度か右上の更新ボタンを押して、論理ID <自分で決めたスタック名>のステータスがCREATE_COMPLETEになっていれば作成が成功しています。
この例の場合ではisucon-practiceがCREATE_COMPLETEになっているので作成が完了していることがわかります。
![](/images/3.4/2021-09-01-21-02-15.png)

これにより、ベンチマーカーと競技サーバー3台が起動し、それぞれ入力したGitHub IDに登録されている公開鍵に対応した秘密鍵を用いて `ssh isucon@<インスタンスIPアドレス>` でログインが可能になっています。
また、以下のようにVPC内でプライベートIPアドレスが設定されています。
- ベンチマーカー：`192.168.0.10`
- サーバー1：`192.168.0.11`
- サーバー2：`192.168.0.12`
- サーバー3：`192.168.0.13`
  

## 動作確認
ベンチマーカーインスタンスにSSHでログインし、ベンチマークが正常に終了することで動作確認します。

上のタブからリソースタブに移動し、BenchmarkerInstanceIPを確認します。
![](/images/3.4/2021-09-01-21-09-02.png)

以下のコマンドを実行してベンチマーカーを実行します。
```
# 手元のターミナル
$ ssh isucon@<BenchmakerInstanceIP>

# インスタンス内
$ cd bench/
$ ./bench -tls -all-addresses "192.168.0.11,192.168.0.12,192.168.0.13" -jia-service-url http://192.168.0.10:5000 -target 192.168.0.11
```

一分程度のベンチマークログが表示された後、以下のようにスコアが表示されれば環境構築は成功です。

```
22:36:18.437839 score: 2249(2274 - 25) : pass
22:36:18.437851 deduction: 0 / timeout: 253
22:36:18.437858 <=== sendResult finish
```

今回起動したスタックは合計で1時間につき0.6ドルくらい掛かります。
使わない間はインスタンスを休止しておくようにしましょう。